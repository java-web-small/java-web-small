image: maven:3.8.1-openjdk-17-slim

variables:
  # ƒê·ªãnh nghƒ©a c√°c bi·∫øn m√¥i tr∆∞·ªùng cho Maven
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .m2/repository/
    - target/

stages:
  - syntax-check
  - sonarqube-analysis

syntax-check:
  stage: syntax-check
  before_script:
    - mkdir -p .m2/repository
  script:
    - echo "üîÅ Build and check syntax..."
    - ./mvnw verify -DskipTests -Dcheckstyle.skip=true -Dnohttp.checkstyle.skip=true
  rules:
    - if: $CI_COMMIT_BRANCH
      allow_failure: false
  artifacts:
    paths:
      - target/

sonarqube-check:
  stage: sonarqube-analysis
  image: maven:3.8.1-openjdk-17-slim
  dependencies:
    - syntax-check
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar" # Defines the location of the analysis task cache
    GIT_DEPTH: "0" # Tells git to fetch all the branches of the project, required by the analysis task
  before_script:
    - mkdir -p .m2/repository
    - mkdir -p .sonar/cache
  cache:
    key: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}"
    paths:
      - .m2/repository/
      - .sonar/cache/
  script:
    - mvn verify sonar:sonar -Dsonar.projectKey=splus.cec_java-web-small_AZbnXVYG9fW_saT3QWxv -Dcheckstyle.skip=true -Dnohttp.checkstyle.skip=true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
